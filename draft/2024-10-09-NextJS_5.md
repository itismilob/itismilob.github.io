---
layout: post
title: NextJS 5
tags:
  - Token
  - Session
  - JWT
  - OAuth
description: NextJS JWT, OAuth
image: /image/nextjs_logo.webp
comments: true
---

## Token, Session, JWT

> 로그인 기능에서 사용자의 로그인 기록을 저장하여 편하게 사용할 수 있도록 한다.

- 사용자가 가입하면 서버는 사용자의 ID, Password 등의 정보를 DB에 저장한다.
- 로그인 하면 DB에서 사용자 정보를 비교해 확인하고 KEY를 발급한다.
- 발급된 KEY는 사용자가 가지고 다른 여러가지 요청을 보낼 때 같이 보낸다.


KEY는 Session 방식과 Token을 사용하는 방식으로 나뉜다.
- Session : 서버에서 로그인 정보를 저장하고 사용자에게 session ID를 발급해주는 방식
	- 장점 : 요청마다 로그인 상태를 엄격하게 확인한다.
	- 단점 : DB 조회를 많이 한다.
- Token (JWT) : 사용자에게 로그인 정보를 암호화한 Token을 보내주고, 요청마다 Token을 받아 확인한다.
	- Token을 암호화 할 때 비밀 키를 추가해 위조를 확인할 수 있다.
	- 장점 : 요청을 처리할 때 DB를 조회하지 않는다.
	- 단점 : token을 훔쳐가면 강제로 로그아웃 시킬 수 없다.

---

## OAuth

> 다른 사이트에 로그인하여 사용 권한, 회원 정보 등을 빌려온다.
> 회원가입, 로그인을 다른 사이트의 정보로 하는 소셜 로그인을 만들 수 있다.
> Google, Facebook, Kakao 등 다양한 OAuth를 사용할 수 있다.

NextJS에는 NextAuth.js 라이브러리를 사용해 쉽게 구현 가능하다.
- 장점 : 아이디/비번 로그인 구현, 유저 정보를 DB에 보관 가능
- 단점 : 아이디/비번 옵션을 사용하면 JWT로 제한된다. (보안 문제)

---

## 소셜 로그인

> next-auth를 사용해 Github 계정을 연결한 소셜 로그인을 구현한다.
> next-auth는 기본적으로 JWT 방식을 사용한다.

깃허브의 OAuth를 사용하기 위해 OAuth App을 등록해야 한다.

1. github 로그인
2. Settings - Developer Settings - OAuth Apps 로 들어가  App을 추가한다. (url은 nextjs url 사용)
3. pages/api/auth/**\[...nextauth].ts** 파일을 만들어서 설정 코드를 작성한다.


```ts title:"[...nextauth].ts"
import NextAuth from "next-auth";
// Github OAuth를 사용
import GithubProvider from "next-auth/providers/github";

export const authOptions = {
	providers: [
		GithubProvider({  
			clientId: 'Github에서 발급받은ID', 
			clientSecret: 'Github에서 발급받은Secret',
		}),
	],
	secret : 'jwt생성시쓰는암호'
};

export default NextAuth(authOptions);
```

---

로그인, 로그아웃 기능을 만들기 위해서는 next-auth/react의 signIn, signOut 함수를 활용하면 된다.
signIn 함수가 실행되면 깃허브 로그인 페이지로 이동한다.

```tsx title:"login/logout"
"use client"
import { signIn } from "next-auth/react";

export default function LoginBtn(){
	return (
		<button onClick={()=>{
			signIn();
		}}>
			login
		</button>
	)
}
```

---

Login을 하면 Logout 버튼과 유저 정보를 출력하기 위해서 navbar를 수정한다.

```tsx title:"layout.tsx"
import { getServerSession } from "next-auth";
import { authOptions } from "@/pages/api/auth/[...nextauth]";

export default async function Layout({
...
let session = await getServerSession(authOptions);

return
	...          
	// session.user.name 있을 경우 logout / 없을 경우 login
	{session?.user?.name ? (
		<div>
			{session.user.name}
			<LogoutBtn />
		</div>
	) : (
		<LoginBtn />
	)}
```



---

### Session을 사용하는 방법

> session 방식으로 연결하기 위해서 adapter 설정을 해줘야 한다.
> mongodb-adapter를 설치한다. (다른 DB를 사용하는 경우 DB에 맞는 adapter를 사용)

```bash title:"install"
// mongodb-adapter를 사용하기 위해 mongodb 4 버전을 사용한다.
npm install mongodb@4
npm install @next-auth/mongodb-adapter
```

adapter를 option으로 추가해준다.

```ts title:"mongoDB adapter"
...
import { connectDB } from "@/utils/database";
import { MongoDBAdapter } from "@next-auth/mongodb-adapter";

export const authOptions = {
  providers: [
    GithubProvider({
		clientId: 'Github에서 발급받은ID', 
		clientSecret: 'Github에서 발급받은Secret',
    }),
  ],
	secret : 'jwt생성시쓰는암호'
	adapter: MongoDBAdapter(connectDB),
};
...
```

mongoDB 가서 보면 accounts, sessions, users  schema들이 생겼을꺼임
계정 정보들 저장됨

\+ 어쩌고 저쩌고 

---

## 본인 글 수정/삭제

> 글을 작성할 때 글쓴이 정보 저장한다.
> 글을 수정/삭제 할 때 글쓴이 본인이 맞는지 확인한다.

유저 정보를 클라이언트가 직접 보내면 위험하다
getServerSession으로 session만 따로 받아온다.
